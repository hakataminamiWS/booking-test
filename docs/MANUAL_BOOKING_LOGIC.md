# 手動予約登録時の UI ロジック、バリデーションロジック

## 1. 概要

このドキュメントは、店舗スタッフやオーナーが管理画面から手動で予約を登録・編集する際のロジックを定義します。

-   UI
-   バリデーション

お客様向けのオンライン予約とは異なり、店舗側の裁量による柔軟な予約登録（例：担当スタッフシフト外での予約登録）を可能にすることを目的とします。

---

## 2. 基本方針

-   予約登録時、担当スタッフのシフト外での予約登録は警告を主としブロックはしない。

---

## 3. UI 挙動

### 1. 必須項目

-   メニュー（セレクトボックス）
-   担当スタッフの選択（セレクトボックス）
-   予約したい年月日（カレンダー形式）
-   予約したい時分（chip を選択する形式＋直接入力も可能）

-   予約者名
-   連絡先電話番号
-   連絡先メールアドレス

### 2. オプション項目

-   オプション（セレクトボックス、複数選択可）
-   予約者からのメモ

### 3. フィルタリング機能

フィルタリングは以下の順序で適用されます。
フィルタリング条件が複数ある場合、各フィルタリング条件をすべて満たす選択肢のみが表示されます。

1. メニューによるフィルタリング
   メニューにより選択できる内容が制限される項目
   フィルタリングの不整合を防ぐため、メニュー選択が変更された場合、以下の制限される項目はリセットされる。

-   担当スタッフ：
    担当スタッフの割り当てが必須のメニューの場合、担当スタッフ選択肢は割り当てられたスタッフのみ
    担当スタッフの割り当てが必須でないメニューの場合、担当スタッフ選択肢は制限なし
-   予約したい年月日：
    特別な予約締め切りが必要なメニューの場合、予約可能な年月日が制限される
    特別な予約締め切りが必要でないメニューの場合、予約可能な年月日は店舗設定による制限
-   予約したい時分：
    特別な予約締め切りが必要なメニューの場合、予約可能な時分が制限される
    特別な予約締め切りが必要でないメニューの場合、予約可能な時分は店舗設定による制限

2. 担当スタッフによるフィルタリング
   担当スタッフにより選択できる内容が制限される項目
   フィルタリングの不整合を防ぐため、担当スタッフ選択が変更された場合、以下の制限される項目はリセットされる。

-   予約したい年月日：
    担当スタッフのシフトに基づき、予約可能な年月日が制限される
    指名なしの場合、選択可能な担当スタッフのシフトに基づき、予約可能な年月日が制限される
-   予約したい時分：
    担当スタッフのシフトに基づき、予約可能な時分が制限される
    指名なしの場合、選択可能な担当スタッフのシフトに基づき、予約可能な時分が制限される
    予約したい時分は、直接入力も可能とする。担当スタッフのシフト外の場合、警告メッセージを表示します。

3. 予約したい年月日によるフィルタリング
   予約したい年月日により選択できる内容が制限される項目
   フィルタリングの不整合を防ぐため、予約したい年月日が変更された場合、予約したい時分は再計算され再表示される。

### 4. フィルタリングオフ機能

店舗スタッフやオーナーが手動で予約を登録・編集する際、フィルタリング機能をオフにできるチェックボックスを提供します。

-   担当者選択セクションに表示するチェックボックスのラベル: 「メニューに割り当たっていない担当スタッフも表示する」
    チェックを入れると、メニューに割り当たっているスタッフ、割り当たっていない担当スタッフをそれぞれ分けて、担当者選択肢に表示します。

-   予約したい年月日選択セクションに表示するチェックボックスのラベル: 「担当スタッフのシフト外も表示する」
    チェックを入れると、担当スタッフのシフト外の日付も予約したい年月日選択肢に表示します。
    選択された年月日、時分が担当スタッフのシフト外の場合、警告メッセージを表示します。

### 5. 予約したい時分の chip 選択肢

以下の条件に基づき、予約したい時分の chip 選択肢を生成・表示します。

-   予約枠の表示単位（分）
-   担当スタッフのシフト開始・終了時刻
-   担当スタッフの予約状況
-   メニュー＋オプションの所要時間
-   メニュー固有の予約締め切り（分単位）
-   メニュー固有の予約締め切りがない場合は、店舗の基本予約締め切り（分単位）

例:
a. 予約枠の表示単位が 15 分の場合
b. 担当スタッフのシフトが 09:20-18:00
c. 担当スタッフの予約状況が 10:15-11:00 に既存予約あり
d. メニュー＋オプションの所要時間が 45 分
e. メニュー固有の予約締め切り（分単位）が 30 分
f. 店舗の基本予約締め切り（分単位）が 20 分

chip 選択肢は、以下のように生成・表示されます。
a. 予約枠の表示単位が 15 分のため、15 分刻みで選択肢を表示します。00:00、00:15、00:30、00:45、01:00、...、23:45 となります。
b. シフト開始時刻が 09:20、シフト終了時刻が 18:00 のため、09:15 より前、18:00 より後の選択肢は表示しません。
c. 10:15-11:00 に既存予約があるため、10:15、10:30、10:45 の選択肢は表示しません。
d. メニュー＋オプションの所要時間が 45 分のため、09:45 では、09:45-10:30、17:30 では、17:30-18:15 となり、予約状況、シフト終了時間と重なるため、09:45、17:30 の選択肢は表示しません。
e. メニュー固有の予約締め切り（分単位）が 30 分のため、現在時刻が 09:00 の場合、09:30 より前の選択肢は表示しません。
f. メニュー固有の予約締め切りがない場合は、店舗の基本予約締め切り（分単位）が 20 分のため、現在時刻が 09:00 の場合、09:20 より前の選択肢は表示しません。
結果として、09:30、10:00、11:00、11:15、...、17:15 の選択肢が表示されます。

## 4. バリデーション

-   必須項目の入力チェック

    -   予約日時、メニュー、予約者名などの必須項目が入力されていることをチェックします。必須項目が未入力の場合、エラーメッセージを表示し、登録は中止します。

-   入力形式のチェック

    -   連絡先電話番号、メールアドレスなどの入力形式が正しいことをチェックします。形式が不正な場合、エラーメッセージを表示し、登録は中止します。

-   予約したい時分へのチェック
    シフト外予約登録を許可するため、警告のみ表示し登録は中止しません。

    -   担当スタッフのシフト外の時分が選択された場合、警告メッセージを表示します（例：「担当スタッフのシフト外の時間が選択されています。」）
    -   メニューの予約締め切り時間を満たしていない時分が選択された場合、警告メッセージを表示します（例：「選択された時間は、メニューの予約締め切り時間を満たしていません。」）
    -   同一担当スタッフ、同一日時で既存予約が存在する場合、警告メッセージを表示します（例：「同一担当スタッフ、同一日時で既に予約が存在します。」）

---

## 5. ChatGPT による一次回答

以下は「状態を持たない（pure）関数で最終的な予約 chip 候補を算出する設計の概要」と、それを既存アーキテクチャ（Laravel ＋ Blade／Vue）と安全に結合するための UI 提案・運用上の注意点です。

① フロント側の構造（概念レイヤ）
A. メニュー選択 → スタッフ取得フェーズ

目的： メニュー提供が可能なスタッフのみを返す
呼び出すロジック： getAvailableStaff(menuId)

概要ロジック（責務）

メニュー ID をキーに「対応できるスタッフ」を取得

スタッフの勤務状況ではなく「スキル適合」のみ判断

結果：スタッフ一覧（候補）

B. スタッフ選択 → シフト日取得フェーズ

目的： スタッフの 勤務日 情報を取得し、表示するカレンダーに反映
呼び出すロジック： getShiftDays(staffId, yearMonth)

概要ロジック（責務）

指定した年月のシフト日を返す

カレンダーに「選択可能（勤務日）」「選択不可（非勤務日）」として反映

勤務日判定のみで、細かい時刻帯はまだ判断しない

C. 日付選択 → 時間帯候補（chip）取得フェーズ

目的： シフト・予約状況・メニュー時間を統合して時間帯 chip を生成
呼び出すロジック： getTimeChips(staffId, menuId, targetDate)

概要ロジック（責務）

シフト開始/終了から予約可能時間帯をブロックとして取得

既存予約を除外

メニュー所要時間で連続枠を評価

判定結果を「chip」として返す

② API/Server 側の責務分離案
/menus/{id}/staffs
→ getAvailableStaff(menuId)

/staffs/{id}/shifts?yearMonth=2025-11
→ getShiftDays(staffId, yearMonth)

/staffs/{id}/timeslots?menuId=X&date=2025-11-30
→ getTimeChips(staffId, menuId, targetDate)

明確に責務分割され、再利用性も高い構造。

③ ロジック再利用のポイント
共通ユーティリティ：勤務判定系

isWorkingDay(staffId, date)

getShiftBlocks(staffId, date)
→ B と C の両方で利用可能

共通ユーティリティ：予約判定系

getExistingReservations(staffId, date)
→ C で利用（時間 chip 計算）

④ 全体のデータフロー（要点）
メニュー選択
↓ getAvailableStaff
スタッフ選択
↓ getShiftDays
日付選択
↓ getTimeChips
時間 chip 選択
↓ 予約確定

整合性が高く、各レイヤーが独立した疎結合構造。

注意点・例外

シフトが深夜跨ぎ（例：22:00–翌 06:00）のケースでは特別処理が必要

メニューが長時間（例：120 分以上）で複数ブロックにわたる場合は連続判定が複雑になる

スタッフが複数店舗兼任のケースでは勤務場所情報が追加で必要

実際の業務運用では「休憩時間」や「仮押さえ予約」も扱う可能性があるため、実装時は仕様確認が必須（専門家に確認が必要）

出典

一般的な予約管理システム設計（SaaS 予約管理の共通設計パターン）

予約管理における責務分離のドメインモデル（DDD: Domain-Driven Design の慣習）
