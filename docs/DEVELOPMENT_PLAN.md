# 予約機能 開発計画書 (v1.3 Gemini改訂版)

本ドキュメントは、「予約機能仕様書」に基づき、具体的な実装タスクと開発のフェーズを定義する。

---

## 1. 実装タスク一覧

### 1.1. バックエンド (Laravel) タスク

- **環境設定・データ管理**
  - [ ] `.env.example` に必要な環境変数（DB, Mail, etc.）を定義
  - [ ] `shops`, `menus`, `staff` 等のテストデータを作成するDatabase Seederを実装

- **データベース設計・マイグレーション**
  - [ ] `menus` テーブルのマイグレーション作成
  - [ ] `staff` テーブルのマイグレーション作成（`shop_id`, `role` を含む）
  - [ ] `bookings` テーブルのマイグレーション作成（`start_at` を UTC で保存）
  - [ ] モデル (`Menu`, `Staff`, `Booking`) とリレーション定義

- **APIエンドポイント実装**
  - [ ] `GET /api/shops/{shop_id}/menus`
  - [ ] `GET /api/shops/{shop_id}/staff`
  - [ ] `GET /api/shops/{shop_id}/available-slots`

- **予約処理実装**
  - [ ] `POST /bookings` のWebルートとコントローラ (`BookingsController@store`)
  - [ ] `BookingFormRequest` (バリデーションと認可)
  - [ ] `BookingMail` (予約完了通知メール)
  - [ ] 予約日時の二重予約チェックとDB保存処理（DBから予約枠取得、アプリ側で予約可能時間計算、予約POST時にDB状況チェック、予約可能ならSQL実行、SQL実行後DB内容再チェック、アプリ側チェックOKなら登録確定、NGならロールバック）

- **ワークフローと品質保証**
  - [ ] `ShopPolicy`, `BookingPolicy` 等の認可ポリシー実装
  - [ ] Feature Test作成 (正常系、異常系、二重予約防止など)
  - [ ] CI（GitHub Actions）設定: push時にテストとコードスタイルチェック(Pint)を自動実行

---

### 1.2. フロントエンド (Vue) タスク

- **コンポーネント設計・作成**
  - [ ] 親コンポーネント `BookingForm.vue` 作成
  - [ ] ステップごとの子コンポーネントに分割

- **状態管理・モック**
  - [ ] Piniaストアによるフォーム全体の状態管理の実装（型・初期値も定義）
  - [ ] API未完成時に備え、各APIレスポンスのモックデータを作成・利用

- **UI実装 (ステップごと)**
  - [ ] **Step 1 (メニュー)**: API連携、選択機能、エラー表示・再試行
  - [ ] **Step 2 (オプション)**: API連携、選択機能、エラー表示
  - [ ] **Step 3 (日時)**: カレンダー連携、動的なAPI呼び出し、空き時間表示、ロード表示、エラー処理
  - [ ] **Step 4 (顧客情報)**: 入力フォーム、リアルタイムバリデーション
  - [ ] **Step 5 (確認)**: 情報表示、`hidden`フィールドへの値セット、二重送信防止

- **Bladeとの連携**
  - [ ] `create.blade.php` へのVueコンポーネントのマウントと `<form>` タグの配置

---

## 2. 開発フェーズ

### フェーズ1: バックエンド基盤構築
- **目的**: 開発の土台となるデータ構造と環境を整備する。
- **主なタスク**:
  - `.env.example` の設定
  - データベースのマイグレーションとSeederの作成
  - モデルとリレーションの定義
  - APIとWebルートの雛形作成

### フェーズ2: API詳細実装とCI導入
- **目的**: フロントエンドが必要とするデータを返せる状態にし、コード品質の自動チェック機構を導入する。
- **主なタスク**:
  - 各APIのロジック実装
  - APIのFeature Test作成
  - CI (GitHub Actions) の設定と稼働確認

### フェーズ3: フロントエンド実装
- **目的**: API（またはモック）から取得したデータを使い、ユーザーが操作するUIを構築する。
- **主なタスク**:
  - Vueコンポーネントの骨格作成
  - 各ステップの画面を順に実装 (API連携、状態管理含む)

### フェーズ4: 予約実行フローの結合とテスト
- **目的**: フロントからバックエンドまでの一連の予約フローを完成させ、動作を保証する。
- **主なタスク**:
  - `POST /bookings` への連携実装
  - `FormRequest` とコントローラ処理の実装
  - メール送信テスト (Mailtrap等)
  - 排他制御の動作確認

### フェーズ5: 仕上げとドキュメント更新
- **目的**: 全体的な品質を高め、プロジェクトを最新の状態に保つ。
- **主なタスク**:
  - レスポンシブ、アクセシビリティ、ブラウザ互換性の最終確認
  - 全体を通した手動テスト
  - `npm run build` によるフロントエンドビルドの成功確認
  - `ARCHITECTURE.md` や `GEMINI.md` など関連ドキュメントの更新