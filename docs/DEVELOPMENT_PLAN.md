# 予約機能 開発計画書 (v1.5)

本ドキュメントは、「予約機能仕様書」および関連する設計ドキュメントに基づき、具体的な実装タスクと開発のフェーズを定義する。

---

## 1. 実装タスク一覧

### 1.1. バックエンド (Laravel) タスク

- **データベース設計・マイグレーション**
  - [ ] `DATABASE_SCHEMA.md` の最終定義に基づき、全テーブルのマイグレーションファイルを作成・修正
  - [ ] モデル (`User`, `Shop`, `Menu`, `Booking`, `Option`, `ShopRecurringHoliday`等) とリレーション定義
  - [ ] `User`, `Menu`モデル等にマスターデータ削除時の関連IDをNULL化するObserverを実装

- **データSeeder実装**
  - [ ] `DATA_SETUP_SPEC.md` に基づくテストデータを作成するDatabase Seederを実装

- **APIエンドポイント実装**
  - [ ] `GET /api/shops/{shop_id}/menus`
  - [ ] `GET /api/shops/{shop_id}/staff`
  - [ ] `GET /api/menus/{menu_id}/options` (新規)
  - [ ] `GET /api/shops/{shop_id}/available-slots` (新規ロジック反映)
  - [ ] 店舗管理関連API (`time_slot_interval`等のCRUD)
  - [ ] 休日設定API (`shop_recurring_holidays`, `shop_specific_holidays`のCRUD)
  - [ ] オプション管理API (`options`, `menu_option`のCRUD)

- **予約処理実装**
  - [ ] `POST /shops/{shop_id}/bookings` のWebルートとコントローラ (`BookingsController@store`)
  - [ ] `BookingFormRequest` (バリデーションと認可、`option_ids`も考慮)
  - [ ] 予約確定処理に`booking_option`テーブルへの保存ロジックを追加
  - [ ] `BookingMail` (予約完了通知メール、オプション情報も含む)

- **品質保証**
  - [ ] 各種認可ポリシー (`ShopPolicy`, `BookingPolicy` 等) の実装
  - [ ] Feature Test作成 (正常系、異常系、オプション付き予約、マスター削除時の挙動など)
  - [ ] CI（GitHub Actions）設定: push時にテストとコードスタイルチェック(Pint)を自動実行

---

### 1.2. フロントエンド (Vue) タスク

- **コンポーネント設計・作成**
  - [ ] 親コンポーネント `BookingForm.vue` 作成
  - [ ] ステップごとの子コンポーネントに分割
  - [ ] **店舗管理画面**: 休日設定、予約設定UIコンポーネント作成

- **状態管理**
  - [ ] Piniaストアによるフォーム全体の状態管理の実装

- **UI実装 (予約フォーム)**
  - [ ] **Step 1 (メニュー)**: API連携、選択機能
  - [ ] **Step 1.5 (オプション)**: 動的なAPI連携、複数選択機能、合計金額・時間のリアルタイム計算
  - [ ] **Step 2 (スタッフ)**: API連携、選択機能
  - [ ] **Step 3 (日時)**: カレンダー連携、動的なAPI呼び出し
  - [ ] **Step 4 (顧客情報)**: 入力フォーム、リアルタイムバリデーション
  - [ ] **Step 5 (確認)**: 全情報（オプション含む）表示、`hidden`フィールドへの値セット、二重送信防止

- **Bladeとの連携**
  - [ ] `create.blade.php` へのVueコンポーネントのマウントと `<form>` タグの配置

---

## 2. 開発フェーズ

### フェーズ1: バックエンド基盤構築
- **目的**: 開発の土台となるデータ構造とAPIの雛形を整備する。
- **主なタスク**: マイグレーション作成、モデル定義、Seeder作成、API・Webルート雛形作成、Observer実装。

### フェーズ2: API詳細実装とCI導入
- **目的**: フロントエンドが必要とするデータを返せる状態にし、コード品質の自動チェック機構を導入する。
- **主なタスク**: 各APIのロジック実装（予約枠計算、CRUD等）、Feature Test作成、CI設定。

### フェーズ3: フロントエンド実装
- **目的**: APIから取得したデータを使い、ユーザーが操作するUIを構築する。
- **主なタスク**: Vueコンポーネント実装（予約フォーム、店舗管理画面）。

### フェーズ4: 結合とE2Eテスト
- **目的**: フロントからバックエンドまでの一連のフローを完成させ、動作を保証する。
- **主なタスク**: 予約確定処理の結合、メール送信テスト、全体を通した手動テスト。

### フェーズ5: 仕上げとドキュメント最終確認
- **目的**: 全体的な品質を高め、プロジェクトを最新の状態に保つ。
- **主なタスク**: レスポンシブ対応、最終ビルド確認、全ドキュメントの最終レビュー。