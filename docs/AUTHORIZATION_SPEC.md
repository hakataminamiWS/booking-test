# 認可設計仕様書

## 1. 目的

このドキュメントは、予約システムにおける各ユーザーロールの権限と、その技術的な実装方針を定義します。

## 2. ユーザーロール

本システムのユーザーロールは以下の通りです。

| ロール名   | 説明                                                             |
| :--------- | :--------------------------------------------------------------- |
| **Admin**  | システム全体を管理するスーパーユーザー。                         |
| **Owner**  | 自身が契約する店舗のオーナー。スタッフ管理や店舗情報管理を行う。 |
| **Staff**  | 店舗に所属するスタッフ。予約管理やシフト登録を行う。             |
| **Booker** | 会員登録済みの予約者。                                           |
| **Guest**  | 会員登録をしていない予約者。                                     |

## 3. 基本的な実装方針

-   **Policy の活用**: モデルやリソースに対する認可ロジックは、Laravel の **Policy** (`ShopPolicy`, `BookingPolicy`等) に集約します。これにより、リソースと権限ロジックの関連性が明確になります。
-   **Gate の活用**: 特定のロールにのみ許可される操作（例: 管理者ダッシュボードへのアクセス）など、リソースに紐付かない権限については **Gate** を利用します。
-   **`spatie/laravel-permission`について**: 本パッケージは高機能ですが、ロールが固定的で権限ロジックが複雑な本プロジェクトにおいては過剰設計となる可能性があるため、現時点では導入せず、Laravel 標準の Gate と Policy を中心に実装します。

## 4. 権限マトリクス

各ロールに許可される操作の一覧です。

| ユーザーロール | リソース     | アクション             | 権限  | 備考                                                          |
| :------------- | :----------- | :--------------------- | :---- | :------------------------------------------------------------ |
| **Admin**      | Owner        | 登録                   | ○     | Admin のみ (`Gate`で制御)                                     |
|                | **All**      | **全操作**             | **◎** | **スーパーユーザーとして全ての操作が可能 (`before`メソッド)** |
| **Owner**      | Shop         | 登録・更新・削除       | ○     | 自身の契約する店舗のみ                                        |
|                | (Staff 権限) | (Staff と同じ)         | ○     | Staff ができることは全て可能                                  |
| **Staff**      | Booking      | 照会・登録・変更・削除 | ○     | 自身の所属する店舗の予約のみ                                  |
| **Booker**     | Booking      | 照会・削除             | ○     | 自身の予約のみ                                                |
|                | Booking      | 変更                   | ×     | **予約の変更は不可**                                          |
| **Guest**      | Booking      | 登録                   | ○     |                                                               |
|                | Booking      | 削除                   | ○     | **トークンベースの認可** (後述)                               |

## 5. 特殊なケースの認可設計

### 5.1. 管理者 (Admin) の専用権限

管理者はスーパーユーザーではなく、システムの根幹に関わる以下の特定の操作のみが許可されます。

-   オーナーの登録・削除
-   オーナーと契約の紐付け（契約管理）

予約の変更など、他のロール（Owner, Staff）が担当する操作は許可されません。

#### 実装方針

管理者の権限は、操作の種類に応じて個別に実装します。

1.  **リソース関連の操作 (Policy)**

    -   店舗の登録・削除のように、特定のモデル（リソース）に紐づく操作は、各 Policy のメソッド内で管理者かどうかを判定します。
    -   スーパーユーザーではないため、Policy の`before`メソッドによる全件許可は**行いません**。

    ```php
    // app/Policies/ShopPolicy.php (実装イメージ)
    public function create(User $user): bool
    {
        return $user->isAdmin();
    }

    public function delete(User $user, Shop $shop): bool
    {
        return $user->isAdmin();
    }
    ```

2.  **リソースに紐付かない操作 (Gate)**

    -   オーナーの登録や、オーナーと店舗の紐付け画面へのアクセスなど、特定のモデルに紐付かない操作は`Gate`で制御します。

    ```php
    // app/Providers/AuthServiceProvider.php (実装イメージ)
    Gate::define('admin-only-operation', function (User $user) {
        return $user->isAdmin();
    });
    ```

### 5.2. ゲスト (Guest) の予約

#### 予約作成

-   ゲストが予約を作成する際、`users`テーブルに`is_guest = true`として新しいユーザーレコードを作成します。
-   これにより、全ての予約が`users`テーブルのレコードに紐付き、データの一貫性を保ちます。
-   `BookingPolicy`の`create`メソッドは、ログインしていないユーザーも許容するため、引数の型を`?User`とします。
    ```php
    public function create(?User $user): bool
    {
        return true;
    }
    ```

#### 予約キャンセル（削除）

-   ゲストはログインしていないため、通常の認可フローは適用できません。
-   代わりに「**秘密の URL を知っていること**」を認可の根拠とする**トークンベースの認可**を採用します。
-   **フロー**:
    1. 予約作成時に、推測不可能なランダムなトークンを生成し、`bookings`テーブルに保存します。
    2. 予約完了メール等で、そのトークンを含んだキャンセル専用 URL をゲストに通知します。
    3. ゲストがその URL にアクセスすると、コントローラーはトークンを検証し、正しければ予約をキャンセルします。
-   **セキュリティ要件**:
    -   トークンは、ID のような推測可能な値であってはなりません。
    -   サーバーサイドで必ずキャンセル可能期限をチェックする必要があります。
