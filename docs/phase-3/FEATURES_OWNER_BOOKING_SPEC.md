# オーナー向け予約管理機能仕様書

## 1. 目的

このドキュメントは、店舗オーナー (Owner) が利用する予約管理機能の UI/UX、API エンドポイント、
およびデータインタラクションに関する詳細な仕様を定義します。

## 2. 対象ユーザー

-   Owner (店舗オーナー)

---

## 3. 機能・画面仕様詳細

### 予約一覧画面（通常の一覧画面）

#### 機能概要

オーナーが店舗の予約を一覧で確認し、検索や絞り込みを行うための基本画面です。
ここから各予約の詳細確認や、手動での新規予約登録へ進みます。
一覧画面は、`docs/phase-3/INDEX_PAGE_IMPLEMENTATION_PATTERNS.md`で定義された標準パターンで実装します。

#### 画面仕様詳細 (`/owner/shops/{shop}/bookings`)

##### 表示項目一覧

リンクセクション：

-   店舗詳細画面へのリンクをページ上部に表示します。

店舗ヘッダー：

-   `店舗：{店舗名} (店舗 ID: {店舗 ID})` の共通ヘッダーを表示します。

予約一覧セクション：

-   セクションタイトル: `予約一覧`
-   「手動で予約を登録する」ボタン:
    -   セクションタイトルと横並びで配置します（ボタンは右寄せ）。
    -   クリックすると手動予約登録画面 (`/owner/shops/{shop}/bookings/create`) へ遷移します。

| カラム（ラベル） | 表示内容                                          | フィルタ          | ソート | 操作           |
| :--------------- | :------------------------------------------------ | :---------------- | :----- | :------------- |
| 予約日時         | `bookings.start_at` (予約開始日時)                | 可 (日付範囲)     | 可     |                |
| 予約者番号       | `shop_bookers.number`                             | 可 (数値入力)     | 可     |                |
| 顧客名           | `bookings.booker_name`                            | 可 (テキスト入力) | 可     |                |
| メニュー         | `bookings.menu_name`                              | 可 (セレクト)     | 不可   |                |
| 担当スタッフ     | `bookings.assigned_staff_name`                    | 可 (セレクト)     | 不可   |                |
| ステータス       | `bookings.status`                                 | 可 (セレクト)     | 可     |                |
| 合計料金         | `bookings.menu_price` と `booking_options` の合計 | 可 (数値範囲)     | 可     |                |
| 予約経路         | `bookings.booking_channel`                        | 可 (セレクト)     | 可     |                |
| 操作             | 「編集」ボタン                                    | 不可              | なし   | 編集画面へ遷移 |

#### バックエンド仕様

##### ページ表示時のデータ（Web コントローラから渡す情報）

`Owner\BookingController@index` は、Vue コンポーネントをマウントする Blade ビューを返します。その際、以下の情報を`props`として Vue コンポーネントに渡します。

| データ名 | 型       | 説明                       |
| :------- | :------- | :------------------------- |
| `shop`   | `object` | 現在の店舗情報。           |
| `menus`  | `array`  | フィルタ用のメニュー一覧。 |
| `staffs` | `array`  | フィルタ用のスタッフ一覧。 |

##### API エンドポイント

-   **URL**: `GET /owner/api/shops/{shop}/bookings`
-   **コントローラ**: `Api\Owner\BookingController@index`
-   **リクエストクラス**: `App\Http\Requests\Api\Owner\IndexBookingsRequest`
-   **クエリパラメータ**:
    -   `start_at_from` / `start_at_to` (string: YYYY-MM-DD): 予約開始日時による範囲検索。
    -   `booker_number` (integer): 予約者番号による完全一致検索。
    -   `booker_name` (string): 顧客名による部分一致検索。
    -   `menu_id` (integer): メニュー ID による完全一致検索。
    -   `assigned_staff_id` (integer): 担当スタッフ ID による完全一致検索。
    -   `status` (string): ステータスによる検索 (`pending`, `confirmed`, `cancelled`)。
    -   `booking_channel` (string): 予約経路による検索 (`web`, `manual`など)。
    -   `sort_by` (string): ソート対象カラム。許可される値は `start_at`, `booker_number`, `booker_name`, `status`, `total_price`, `booking_channel`。
    -   `sort_order` (string): ソート方向 (`asc` or `desc`)。
    -   `page` (integer): ページ番号。
    -   `per_page` (integer): 1 ページあたりの表示件数。

##### 処理内容

-   `BookingPolicy@viewAny` により、認可されたデータのみが返却されることを保証します。
-   ログインしているオーナーの、URL で指定された店舗に紐づく `bookings` テーブルのレコードを主軸とします。
-   受け取ったクエリパラメータに基づき、動的なフィルタリング、ソーティングを適用します。
-   ページネーションを適用して結果を返却します。
-   「編集」ボタンを押すと、対象予約の編集画面 (`/owner/shops/{shop}/bookings/{booking}/edit`) に遷移します。

---

### 手動予約登録画面

#### 機能概要

オーナーまたはスタッフが、電話や対面などで受け付けた予約を管理画面から直接登録するための画面です。

#### 画面仕様詳細 (`/owner/shops/{shop}/bookings/create`)

-   **ウィンドウタイトル**: `手動予約登録`

##### 表示項目一覧

リンクセクション：

-   「予約一覧に戻る」へのリンクをページ上部に表示します。

店舗ヘッダー：

-   `店舗：{店舗名} (店舗 ID: {店舗 ID})` の共通ヘッダーを表示します。

手動予約登録セクション：

-   予約者選択・登録セクション
    -   予約者、予約者名、予約者のよみがな、連絡先メールアドレス、連絡先電話番号、予約者からのメモなどを入力・選択します。
    -   既存予約者を選択した場合、会員番号を表示し、名前・よみがなは編集不可とします。

-   メニュー・オプション選択セクション
    -   メニューの選択、オプションの追加を行います。
    -   合計時間 / 料金を表示します。

-   担当スタッフ選択セクション
    -   選択されたメニューに基づいて担当可能スタッフを選択します。
    -   メニューに割り当たっていない担当スタッフも表示設定が可能です。

-   予約日時選択セクション
    -   カレンダーからの日付選択、予約可能枠の選択、または時刻の直接入力を行います。
    -   担当スタッフのシフト外も選択設定が可能です。

-   フォーム:
    -   フォーム全体は `<v-card>` で囲みます。
    -   カードタイトルは「手動予約登録」とします。
    -   カードの最下部に「登録する」ボタンを配置します。

##### フォーム項目一覧

| ラベル                   | DB カラム           | UI               | 備考                                                                                                |
| :----------------------- | :------------------ | :--------------- | :-------------------------------------------------------------------------------------------------- |
| 予約日時                 | `start_at`          | テキスト入力     | 必須。カレンダー/時刻選択により入力。                                                               |
| メニュー                 | `menu_id`           | セレクトボックス | 必須。選択により所要時間・価格が自動反映。                                                          |
| オプション               | `option_ids[]`      | 複数選択セレクト | 任意。メニューに紐づくオプションを選択。                                                            |
| 担当スタッフ             | `assigned_staff_id` | セレクトボックス | メニューの設定により必須。                                                                          |
| 会員番号                 | `booker_number`     | テキスト入力     | 任意。既存顧客選択時のみ表示 (Readonly)。                                                           |
| 予約者名                 | `booker_name`       | テキスト入力     | 必須。既存顧客選択時は自動入力 (Readonly)。新規は入力。                                             |
| 連絡先メールアドレス     | `contact_email`     | テキスト入力     | 必須。                                                                                              |
| 連絡先電話番号           | `contact_phone`     | テキスト入力     | 必須。                                                                                              |
| 予約者からのメモ         | `note_from_booker`  | テキストエリア   | 任意。                                                                                              |
| 予約者のよみがな         | `booker_name_kana`  | テキストエリア   | 任意。既存顧客選択時は Readonly。                                                                   |
| 店舗側のメモ             | `shop_memo`         | テキストエリア   | 任意。                                                                                              |
| 予約時メモ               | `memo`              | テキストエリア   | 任意。                                                                                              |

##### バックエンド仕様

###### データ受け渡し (ページ表示)

-   **ルート**: `GET /owner/shops/{shop}/bookings/create`
-   **コントローラ**: `Owner\BookingController@create`
-   **処理内容**:
    -   `BookingPolicy@create` で認可チェックを行います。
    -   フォームの選択肢データを取得し `props` として渡します。

---

### 予約編集画面

#### 機能概要

オーナーが既存の予約内容を変更、または予約自体を削除（キャンセル）するための画面です。
手動予約登録画面をベースにしていますが、予約者の個人を特定する情報は編集できないように制限されています。

#### 画面仕様詳細 (`/owner/shops/{shop}/bookings/{booking}/edit`)

-   **ウィンドウタイトル**: `予約編集`

##### 表示項目一覧

リンクセクション：

-   「予約一覧に戻る」へのリンクをページ上部に表示します。

店舗ヘッダー：

-   `店舗：{店舗名} (店舗 ID: {店舗 ID})` の共通ヘッダーを表示します。

予約編集セクション：

-   予約者情報は変更不可（Readonly）として表示します。
-   連絡先情報は編集可能とします（予約時の連絡先修正用）。
-   予約内容は変更可能とし、手動予約登録と同様のUIで操作します。

-   フォーム:
    -   フォーム全体は `<v-card>` で囲みます。
    -   カードタイトルは「予約編集」とします。
    -   カードの最下部にアクションボタンを配置します。
        -   左側: 「削除する」ボタン（赤色）。クリックすると確認ダイアログが表示されます。
        -   右側: 「更新する」ボタン（プライマリカラー）。

##### フォーム項目一覧 (相違点のみ)

| ラベル       | 状態     | 備考                                                         |
| :----------- | :------- | :----------------------------------------------------------- |
| 会員番号     | Readonly | 変更不可。                                                   |
| 予約者名     | Readonly | 変更不可。基本情報保護のため。                               |
| よみがな     | Readonly | 変更不可。                                                   |
| メニュー     | 初期値   | 予約時のメニューが初期選択された状態。変更可能。             |
| 予約日時     | 初期値   | 予約時の日時が初期設定された状態。変更可能。                 |
| スタッフ     | 初期値   | 予約時のスタッフが初期選択された状態。変更可能。             |

##### バックエンド仕様

###### データ受け渡し (ページ表示)

-   **ルート**: `GET /owner/shops/{shop}/bookings/{booking}/edit`
-   **コントローラ**: `Owner\BookingController@edit`
-   **処理内容**:
    -   `BookingPolicy@update` で認可チェックを行います。
    -   対象の予約データ (`booking`) を取得します。
    -   `Create` と同様のマスタデータ (`menus`, `staffs` 等) を取得します。
    -   これらを `props` として Vue コンポーネントに渡します。

###### 更新処理 (`update`)

-   **ルート**: `PUT /owner/shops/{shop}/bookings/{booking}`
-   **コントローラ**: `Owner\BookingController@update`
-   **リクエストクラス**: `StoreBookingRequest` (または新規の `UpdateBookingRequest`)
    -   `booker_name` 等の必須チェックは、既存データがあるため調整が必要な場合があるが、フォームから全データを送信するため `Store` と共有または継承が可能か検討する。

###### 削除処理 (`destroy`)

-   **ルート**: `DELETE /owner/shops/{shop}/bookings/{booking}`
-   **コントローラ**: `Owner\BookingController@destroy`
-   **処理内容**:
    -   `BookingPolicy@delete` で認可チェック。
    -   予約レコードを削除（システム仕様に従い物理/論理削除）。
    -   削除後、予約一覧へリダイレクトし、完了メッセージを表示する。
