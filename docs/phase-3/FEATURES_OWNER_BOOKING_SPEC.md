# オーナー向け予約管理機能仕様書

## 1. 目的

このドキュメントは、店舗オーナー (Owner) が利用する予約管理機能の UI/UX、API エンドポイント、およびデータインタラクションに関する詳細な仕様を定義します。

## 2. 対象ユーザー

-   Owner (店舗オーナー)

---

## 3. 機能・画面仕様詳細

### 予約一覧画面（通常の一覧画面）

#### 機能概要

オーナーが店舗の予約を一覧で確認し、検索や絞り込みを行うための基本画面です。
ここから各予約の詳細確認や、手動での新規予約登録へ進みます。
一覧画面は、`docs/phase-3/INDEX_PAGE_IMPLEMENTATION_PATTERNS.md`で定義された標準パターンで実装します。

#### 画面仕様詳細 (`/owner/shops/{shop}/bookings`)

##### 表示項目一覧

**リンクセクション：**

-   店舗詳細画面へのリンクをページ上部に表示します。

**店舗ヘッダー：**

-   `店舗：{店舗名} (店舗 ID: {店舗 ID})` の共通ヘッダーを表示します。

**予約一覧セクション：**

-   **セクションタイトル**: `予約一覧`
-   **「手動で予約を登録する」ボタン**:
    -   セクションタイトルと横並びで配置します（ボタンは右寄せ）。
    -   クリックすると手動予約登録画面 (`/owner/shops/{shop}/bookings/create`) へ遷移します。

| カラム（ラベル） | 表示内容                                          | フィルタ          | ソート | 操作           |
| :--------------- | :------------------------------------------------ | :---------------- | :----- | :------------- |
| **予約日時**     | `bookings.start_at` (予約開始日時)                | 可 (日付範囲)     | 可     |                |
| **顧客名**       | `bookings.booker_name`                            | 可 (テキスト入力) | 可     |                |
| **メニュー**     | `bookings.menu_name`                              | 可 (セレクト)     | 不可   |                |
| **担当スタッフ** | `bookings.assigned_staff_name`                    | 可 (セレクト)     | 不可   |                |
| **ステータス**   | `bookings.status`                                 | 可 (セレクト)     | 可     |                |
| **合計料金**     | `bookings.menu_price` と `booking_options` の合計 | 可 (数値範囲)     | 可     |                |
| **予約経路**     | `bookings.booking_channel`                        | 可 (セレクト)     | 可     |                |
| **操作**         | 「詳細」ボタン                                    | 不可              | なし   | 詳細画面へ遷移 |

#### バックエンド仕様

##### ページ表示時のデータ（Web コントローラから渡す情報）

`Owner\BookingController@index` は、Vue コンポーネントをマウントする Blade ビューを返します。その際、以下の情報を`props`として Vue コンポーネントに渡します。

| データ名 | 型       | 説明                       |
| :------- | :------- | :------------------------- |
| `shop`   | `object` | 現在の店舗情報。           |
| `menus`  | `array`  | フィルタ用のメニュー一覧。 |
| `staffs` | `array`  | フィルタ用のスタッフ一覧。 |

##### API エンドポイント

-   **URL**: `GET /owner/api/shops/{shop}/bookings`
-   **コントローラ**: `Api\Owner\BookingController@index`
-   **リクエストクラス**: `App\Http\Requests\Api\Owner\IndexBookingsRequest`
-   **クエリパラメータ**:
    -   `start_at_from` / `start_at_to` (string: YYYY-MM-DD): 予約開始日時による範囲検索。
    -   `booker_name` (string): 顧客名による部分一致検索。
    -   `menu_id` (integer): メニュー ID による完全一致検索。
    -   `assigned_staff_id` (integer): 担当スタッフ ID による完全一致検索。
    -   `status` (string): ステータスによる検索 (`pending`, `confirmed`, `cancelled`)。
    -   `booking_channel` (string): 予約経路による検索 (`web`, `manual`など)。
    -   `sort_by` (string): ソート対象カラム。許可される値は `start_at`, `booker_name`, `status`, `total_price`, `booking_channel`。
    -   `sort_order` (string): ソート方向 (`asc` or `desc`)。
    -   `page` (integer): ページ番号。
    -   `per_page` (integer): 1 ページあたりの表示件数。

##### 処理内容

-   `BookingPolicy@viewAny` により、認可されたデータのみが返却されることを保証します。
-   ログインしているオーナーの、URL で指定された店舗に紐づく `bookings` テーブルのレコードを主軸とします。
-   受け取ったクエリパラメータに基づき、動的なフィルタリング、ソーティングを適用します。
-   ページネーションを適用して結果を返却します。
-   「詳細」ボタンを押すと、対象予約の詳細画面 (`/owner/shops/{shop}/bookings/{booking}`) に遷移します。

---

### 手動予約登録画面

#### 機能概要

オーナーまたはスタッフが、電話や対面などで受け付けた予約を管理画面から直接登録するための画面です。

#### 画面仕様詳細 (`/owner/shops/{shop}/bookings/create`)

##### UI デザイン案

-   **ウィンドウタイトル**: `手動予約登録`

**リンクセクション：**

-   「予約一覧に戻る」へのリンクをページ上部に表示します。

**店舗ヘッダー：**

-   `店舗：{店舗名} (店舗 ID: {店舗 ID})` の共通ヘッダーを表示します。

**手動予約登録セクション：**

-   予約者選択・登録セクション

    -   ラベル: `予約者`
    -   プレースホルダー: `予約者を選択してください`
    -   append icon: 「選択」
    -   予約者選択完了後、予約者、予約者名、連絡先メールアドレス、連絡先電話番号、店舗側のメモを表示する

-   メニュー・オプション選択セクション

    -   ラベル: `メニュー`
    -   プレースホルダー: `メニューを選択してください`
    -   append icon: 「選択」
    -   メニュー選択完了後、オプションを追加するボタンを表示する
        -   オプション選択セクション
        -   ラベル: `オプション`
        -   プレースホルダー: `オプションを選択してください`
        -   append icon: 「選択」
        -   オプション選択完了後、合計時間 / 料金を表示する

-   予約日時選択セクション

    -   予約日付フィールド

        -   ラベル: `予約日付`
        -   プレースホルダー: `日付を選択してください`
        -   append icon: カレンダーアイコン

    -   予約時間フィールド

        -   ラベル: `予約時間`
        -   プレースホルダー: `時間を選択してください`
        -   append icon: 「選択」

-   担当スタッフ選択セクション

    -   ラベル: `担当スタッフ`
    -   プレースホルダー: `担当スタッフを選択してください`
    -   append icon: 「選択」
    -   担当スタッフは、選択されたメニューに基づいて担当可能スタッフのみ表示する
    -   担当スタッフは、選択された予約日時にシフトが入っているスタッフを表示する
    -   シフト外のスタッフも表示するのチェックボックス
    -   シフト外のスタッフも表示するのチェックボックスをオンにすると、シフト外のスタッフも表示する

-   予約完了メール送信チェックボックスセクション

-   **フォーム**:
    -   フォーム全体は `<v-card>` で囲みます。
    -   カードタイトルは「手動予約登録」とします。
    -   カードの最下部に「登録する」ボタンを配置します。

##### フォーム項目一覧

| ラベル                   | UI コンポーネント                         | name 属性           | 備考                                                                                                                |
| :----------------------- | :---------------------------------------- | :------------------ | :------------------------------------------------------------------------------------------------------------------ |
| **予約日時**             | `<v-text-field>` (カレンダーアイコン付き) | `start_at`          | 必須。クリックで日付・時刻選択ダイアログを表示。メニュー選択時に自動計算されるが、手動での上書きも可能。            |
| **メニュー**             | `<v-select>`                              | `menu_id`           | 必須。選択すると、所要時間・価格が自動入力され、担当スタッフやオプションの選択肢が動的に更新される。                |
| **オプション**           | `<v-select multiple>`                     | `option_ids[]`      | 任意。メニュー選択後、そのメニューに紐づくオプションが選択可能になる。                                              |
| **担当スタッフ**         | `<v-select>`                              | `assigned_staff_id` | メニューの `requires_staff_assignment` が `true` の場合は必須。メニュー選択後、担当可能なスタッフが選択可能になる。 |
| **合計時間 / 料金**      | 表示のみ                                  | -                   | メニューとオプションの選択に応じて、合計所要時間と合計料金を自動計算して表示する。（例: `合計: 90分 / 11,000円`）   |
| **予約者**               | `<v-autocomplete>`                        | `shop_booker_id`    | 任意。既存顧客を名前や連絡先で検索・選択できる。選択すると、予約者名・連絡先が自動入力される。                      |
| **予約者名**             | `<v-text-field>`                          | `booker_name`       | 必須。既存顧客を選択した場合は自動入力されるが、上書きも可能。                                                      |
| **連絡先メールアドレス** | `<v-text-field type="email">`             | `contact_email`     | 任意。                                                                                                              |
| **連絡先電話番号**       | `<v-text-field type="tel">`               | `contact_phone`     | 任意。                                                                                                              |
| **予約者からのメモ**     | `<v-textarea>`                            | `note_from_booker`  | 任意。お客様からの要望などを記録。                                                                                  |
| **店舗側のメモ**         | `<v-textarea>`                            | `shop_memo`         | 任意。店舗で管理するための内部メモ。                                                                                |

##### 動的な UI の挙動

1.  **予約者選択**:

    -   予約者を選択のダイアログを表示する
    -   ダイアログの右上に、「キャンセル」、「完了」ボタンを表示する
    -   「予約者を選択」、「予約者の追加」のタブを切り替え可能にする
    -   「予約者を選択」では、検索ボックスと既存予約者リストを表示し、予約者リストから選択可能にする
    -   「予約者を選択」での既存予約者リストには、詳細ボタンを表示し、詳細情報をモーダルで確認可能にする
    -   「予約者の追加」では、予約者名、連絡先メールアドレス、連絡先電話番号、店舗側のメモの入力フォームを表示する
    -   「完了」ボタンで、予約者の選択を確定する。「予約者の追加」で追加した場合は、予約完了時に新規登録を行う

2.  **メニュー・オプション選択**:

    -   メニューのセレクトボックスでメニューを選択すると、以下の動作を行う
    -   選択されたメニューの所要時間を基に、予約日時の終了時刻を自動計算し、予約可能枠を更新する
    -   選択されたメニューに紐づくオプションのみを、オプション選択肢 (`<v-select multiple>`) に表示します。
    -   選択されたメニューを担当可能な担当スタッフのみを、スタッフ選択肢 (`<v-select>`) に表示します。
    -   **合計時間 / 料金**を更新します。

    -   オプションを追加するボタンを押すと、オプション選択セクションを表示する
    -   オプションのセレクトボックスでオプションを選択すると、以下の動作を行う
    -   選択されたオプションの追加所要時間を基に、予約日時の終了時刻を自動計算して更新する
    -   **合計時間 / 料金**を更新します。

3.  **担当スタッフ選択**:

    -   担当スタッフのセレクトボックスでスタッフを選択すると、以下の動作を行う
    -   選択されたスタッフのシフト情報を基に、予約可能枠を更新する
    -   担当スタッフなしを選択した場合は、全スタッフのシフト情報を基に、予約可能枠を更新する
    -   シフト外のスタッフも表示するのチェックボックスをオンにすると、シフト外のスタッフも表示する
    -   すでに選択されている担当スタッフがシフト外の場合、警告メッセージを表示する

4.  **予約日時選択**:
    -   予約日付フィールドをクリックすると、日付選択ダイアログを表示する
    -   予約時間フィールドをクリックすると、直接時間入力要素と、担当スタッフに基づく予約可能枠とを表示する
    -   直接時間入力要素では、担当スタッフのシフト以外でも入力を可能。ただし、シフト外の場合は警告メッセージを表示する
    -   予約可能枠は、chip として時（9 時、10 時、11 時...）ごとに表示する（例：`09:00`, `09:30`, `10:00` ... ）
    -   予約可能枠をクリックすると、その時間が予約時間フィールドにセットされる

#### バックエンド仕様

##### データ受け渡し (ページ表示)

-   **ルート**: `GET /owner/shops/{shop}/bookings/create`
-   **コントローラ**: `Owner\BookingController@create`
-   **処理内容**:
    -   `BookingPolicy@create` で認可チェックを行います。
    -   フォームの選択肢として使用する以下のデータを取得し、`props`として Vue コンポーネントに渡します。
        -   `shop`: 現在の店舗情報
        -   `menus`: 店舗に紐づく全メニュー（オプションと担当可能スタッフの情報も含む）
        -   `staffs`: 店舗に紐づく全スタッフ
        -   `bookers`: 店舗に紐づく全顧客リスト

##### フォーム送信 (登録処理)

-   **ルート**: `POST /owner/shops/{shop}/bookings`
-   **コントローラ**: `Owner\BookingController@store`
-   **リクエストクラス**: `App\Http\Requests\Owner\StoreBookingRequest`

##### バリデーション (`StoreBookingRequest`)

-   **認可**: `authorize`メソッド内で`BookingPolicy@create`を呼び出します。
-   **ルール**:
    -   `start_at`: `required`, `date`
    -   `menu_id`: `required`, `exists:shop_menus,id`
    -   `option_ids`: `nullable`, `array`
    -   `option_ids.*`: `exists:shop_options,id`
    -   `assigned_staff_id`: `nullable`, `exists:shop_staffs,id`
    -   `shop_booker_id`: `nullable`, `exists:shop_bookers,id` (既存顧客を選択した場合)
    -   `booker_name`: `required`, `string`, `max:255`
    -   `contact_email`: `nullable`, `email`, `max:255`
    -   `contact_phone`: `nullable`, `string`, `max:255`
    -   `note_from_booker`: `nullable`, `string`
    -   `shop_memo`: `nullable`, `string`

##### 処理内容

1.  `StoreBookingRequest` で認可とバリデーションを実行します。
2.  データベーストランザクションを開始します。
3.  リクエストに `shop_booker_id` が含まれていない場合、`booker_name`, `contact_email`, `contact_phone`, `shop_memo` を使って `shop_bookers` テーブルに新しい顧客レコードを作成します。
4.  `bookings` テーブルに新しい予約レコードを作成します。`shop_booker_id` には、既存顧客の ID または新規作成した顧客の ID を設定します。
    -   `status` は `confirmed`、`booking_channel` は `manual` で固定します。
    -   メニュー、オプション、予約者情報などは、スナップショットとして `bookings` および `booking_options` テーブルに保存します。
5.  トランザクションをコミットします。
6.  登録後、予約一覧画面 (`/owner/shops/{shop}/bookings`) にリダイレクトし、「予約を登録しました」という成功メッセージを表示します。

#### バリデーションロジック

手動予約登録時のバリデーションは、柔軟な運用を可能にするため、シフト外でも予約登録を許可します。
ただし、シフト外の場合は警告メッセージを表示します。
