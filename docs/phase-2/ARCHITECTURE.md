# ARCHITECTURE.md

## 1. 目的と運用ルール

### 1.1. 目的

この文書は予約サービスの **システムアーキテクチャ** の全体像と設計思想を定義し、開発・運用における共通認識を持つことを目的とします。

### 1.2. 本書の役割

本書は、システム全体のアーキテクチャの概要を示し、より詳細な仕様を記述した `docs/` 配下の他のドキュメントへの **ハブ（索引）** として機能します。アーキテクチャに関する主要な決定事項や全体像を把握したい場合は、まずこのドキュメントを参照してください。

### 1.3. 運用ルール

`docs/` 配下のドキュメントを新規作成または更新する際は、 **必ず本書との整合性を確認してください。** 具体的には、関連するセクションから適切にリンクを張る、あるいは既存のリンクが最新の状態を反映しているかを確認する作業を必須とします。

---

## 2. 関連ドキュメント一覧

### 2.1. ワークフロー仕様書

-   [オーナー新規契約ワークフロー](./OWNER_ONBOARDING_AND_CONTRACT_SPEC.md)
-   (未作成) 店舗スタッフシフト設定ワークフロー
-   (未作成) 予約者予約入力ワークフロー

### 2.2. 機能仕様書

-   **管理者向け**
    -   [管理者機能](./FEATURES_ADMIN_SPEC.md)
-   **オーナー向け**
    -   (未作成) オーナー機能
-   **スタッフ向け**
    -   (未作成) スタッフ機能
-   **予約者・ゲスト向け**
    -   (未作成) 予約者機能
    -   (未作成) ゲスト機能
    -   (未作成) 予約フォーム仕様
    -   (未作成) 予約管理機能
    -   (未作成) 店舗管理機能

### 2.3. 設計・実装ガイドライン

-   [データベース設計](./DATABASE_SCHEMA.md)
-   [認可設計](./AUTHORIZATION_SPEC.md)
-   [実装パターンガイド-一覧画面](./INDEX_PAGE_IMPLEMENTATION_PATTERNS.md)
-   (未作成) 実装パターンガイド-予約フォーム
-   (未作成) 実装パターンガイド-その他
-   (未作成) 空き時間計算ロジック
-   (未作成) 手動予約時のバリデーション

### 2.4. 開発・テスト関連

-   (未作成) テストガイド
-   (未作成) ワークフローテスト
-   (未作成) データセットアップ仕様

---

## 3. アーキテクチャ方針

-   **フロントエンド**: Laravel + Blade (MPA) を基本とし、一部 Vue 3 + Vuetify + TypeScript による動的 UI
-   **バックエンド**: Laravel (API 提供 + 認証・セッション管理)
-   **データベース**: 単一 DB + `shop_id` スコープ管理（将来的に DB 分離型マルチテナントへ拡張可能）
-   **責務分担**:
    -   Laravel + Blade: ページ遷移・認証・セッション・CSRF 管理・フォーム処理
    -   Vue + Vuetify: 予約フォーム UI、予約一覧 (フィルタ/ソート/ページネーション)
-   **API**: Laravel コントローラから JSON を返却、Vue が描画更新

### 3.1. Blade と Vue の連携方式

本プロジェクトでは、Laravel Blade と Vue コンポーネントを以下の方式で連携させることを原則とします。

1.  **Blade テンプレート**:

    -   コントローラから渡されたデータを `json_encode` し、`id="app"` を持つ単一の div 要素の `data-props` 属性にセットします。
    -   どの Vue コンポーネントを呼び出すかを識別するため、`data-page` 属性も併せて指定します。
    -   Blade テンプレート内に直接的な Vue コンポーネントの記述やロジックは含めません。

    ```html
    <!-- 例: resources/views/admin/users/index.blade.php -->
    @php $props = ['users' => $users]; @endphp
    <div
        id="app"
        data-page="admin-users-index"
        data-props="{{ json_encode($props) }}"
    ></div>
    ```

2.  **Vue コンポーネントのマウント**:
    -   `resources/js/app.ts` が `id="app"` の div 要素を検知します。
    -   `data-page` 属性の値をキーとして、対応する Vue コンポーネントを選択します。
    -   `data-props` 属性の JSON 文字列をパースし、コンポーネントのプロパティとして渡してマウントします。

このアーキテクチャにより、サーバーサイド（Laravel）とフロントエンド（Vue）の関心を明確に分離し、見通しの良い開発を維持します。

### 3.2. 一覧画面における動的フィルタリングの実装方針

検索機能を持つすべての一覧画面は、UX と開発効率を両立するため、以下のハイブリッド方針で実装することを原則とします。

-   **目的**: ページ全体のリロードなしに快適なフィルタリング操作を提供しつつ、ブラウザの「戻る」機能や URL の共有を可能にする。
-   **基本方針**: 初回読み込みは Laravel(サーバーサイド)で行い、フィルタリングやページネーションなどの動的な操作は Vue(クライアントサイド)が担当する。

#### 実装フロー

1.  **初回アクセス時 (またはブラウザバック時)**

    -   ユーザーが `GET /admin/users?search=...` のような URL にアクセスします。
    -   Laravel のルーターは、一覧表示用のコントローラメソッドを呼び出します。
    -   コントローラは、URL のクエリパラメータのうち、一覧のフィルタやソートに関するパラメータ (`search`, `sort_by`など) などは、取得しません。つまり、一覧用のデータは取得しません。クライアントサイドは、初回アクセス後に API を呼び出して、一覧のデータを取得します。
    -   csrf トークンや、リダイレクト用の URL path などの一覧のデータ以外の情報を Blade テンプレートから vue コンポーネントに渡します。

2.  **ページ読み込み後のフィルタ操作時**
    -   ページが表示され、Vue コンポーネントが初期化されます。コンポーネントは、URL のクエリパラメータを解釈し、自身のフィルタ状態を初期化します。
    -   ユーザーが検索ボックスに入力するなど、フィルタを操作すると Vue がイベントを捕捉します。
    -   Vue コンポーネントは、`axios`等を用いて `/api/admin/users?search=...` のような**データ取得専用の API エンドポイント**に非同期で GET リクエストを送信します。
    -   同時に、ブラウザの **History API** (`history.pushState`) を利用して、ページをリロードせずに URL を更新します。
    -   API から返却された JSON データを使って、画面の一覧部分のみを動的に再描画します。

この設計により、`vue-router`のような大規模な SPA ライブラリを導入することなく、MPA の安定性と SPA の滑らかな操作性を両立させます。

## より詳細な実装手順については、[実装パターンガイド](./INDEX_PAGE_IMPLEMENTATION_PATTERNS.md)を参照してください。

## 4. マルチテナントと認可設計

オーナーやスタッフが自身の所属する店舗の情報のみを閲覧・操作できるよう、グローバルスコープと Policy を組み合わせてデータ分離を堅牢に実現する。

-   **グローバルスコープ**: `shop_id` による自動的なクエリ絞り込みを行い、意図しない情報漏洩をシステムレベルで防止する。
-   **Policy による認可**: 個別のデータに対する操作権限を厳密に検証し、不正アクセスを防ぐ。

---

## 5. サービス有効性の判定ロジック (契約と店舗ステータスの関係)

本システムでは、サービスの有効性を「契約」と「店舗」の 2 つの階層的なステータスで管理する。

### 5.1. 判定ロジック

1.  その店舗のオーナーに紐づく`contracts`テーブルの`status`が`active`である。
    => オーナーや、スタッフによる管理画面からの予約登録や、シフト登録、各種情報の照会といった操作が可能になる。

2.  かつ、`shops`テーブル自体の`accepts_online_bookings`が`true`である。
    => 顧客（Booker/Guest）による新規予約作成が可能になる。

### 5.2. ステータスの権限管理

各ステータスの更新権限は、責務に基づき厳密に分離される。

| ステータス                          | 更新可能なロール | 照会のみ可能なロール | 備考                                         |
| :---------------------------------- | :--------------- | :------------------- | :------------------------------------------- |
| **`contracts.status`**              | **管理者**       | オーナー             | 請求や法的な合意に基づく状態                 |
| **`shops.accepts_online_bookings`** | **オーナー**     | 管理者               | 店舗の営業状態など、オーナーの裁量による状態 |

**重要**: 上位の`contracts.status`が変更されても、下位の`shops.accepts_online_bookings`が自動的に変更されることはない。これにより、オーナーが意図的に設定した店舗の状態が、システムによって上書きされることを防ぐ。

---

## 6. データモデルに関する重要方針

### 6.1. 顧客アカウントモデルと統合ロジック

ゲスト予約と会員登録ユーザーを柔軟に紐付けるため、「マスターアカウント (`users`)」「来店カード (`bookers`)」「予約票 (`bookings`)」の 3 層モデルを採用する。これにより、予約情報を変更することなく顧客の名寄せ（統合）を可能にする。

### 6.2. データ削除方針

ユーザー退会やメニュー廃止など、マスターデータは **物理削除** を前提とする。削除時はモデルイベントを利用して関連する予約情報 (`bookings`) の外部キーを `NULL` に更新し、参照整合性とデータの匿名性を担保する。

---

## 7. API 設計方針

各ロール（Booker, Staff, Owner, Admin）に応じたエンドポイントを定義する。

-   （未確定）**Booker（予約者向け）**: `/shops/{shop_slug}/bookings` (一覧, 作成, 詳細, 変更, キャンセル)
-   （未確定）**Staff（店舗スタッフ向け）**: `/shops/{shop_slug}/staff/...` (ダッシュボード, 予約管理, シフト管理)
-   （未確定）**Owner（店舗オーナー向け）**: `/owner/...` (ダッシュボード, 店舗管理, スタッフ管理, 契約管理)
-   **Admin（全体管理者向け）**: `/admin/...` (オーナー管理, 契約管理)

---

## 8. ディレクトリ構成

-   `app/Http/Controllers/{Role}/`
-   `app/Services/`
-   `app/Policies/`
-   `resources/views/{role}/`
