# 管理者機能仕様書

## 1. 目的

このドキュメントは、システム管理者 (Admin) が利用する機能の UI/UX、API エンドポイント、およびデータインタラクションに関する詳細な仕様を定義します。

## 2. 対象ユーザー

-   Admin (システム管理者)

---

## 3. 主な画面と機能

本仕様書で定義する主な画面と、その機能概要は以下の通りです。

-   **[契約申し込み一覧画面](#4-契約申し込み一覧画面)**
    -   オーナーからの契約申し込みを一覧で確認し、絞り込み検索を行います。
-   **[オーナー情報・契約管理画面](#5-オーナー情報契約管理画面)**
    -   特定のユーザーの詳細情報を確認し、オーナー権限の付与や契約の管理を行います。
-   **[オーナー権限一覧画面](#6-オーナー権限一覧画面)**
    -   システムに登録されている全ユーザーの権限状態を一覧で確認し、各ユーザーの詳細画面へ遷移します。

---

## 4. 契約申し込み一覧画面

### 4.1. 機能概要

オーナーからの契約申し込みを一覧で確認し、各申し込みに対して契約作成などのアクションを行うための画面です。

### 4.2. 画面仕様詳細 (`/admin/contract-applications`)

#### 表示項目一覧

| カラム（ラベル） | 表示内容                                                                                        | フィルタ                                  | ソート | 操作       |
| ---------------- | ----------------------------------------------------------------------------------------------- | ----------------------------------------- | ------ | ---------- |
| 申込 ID          | contract_applications.id                                                                        | 可 (インプット)                           | 可     | 空白       |
| PublicID         | contract_applications.user_id => users.public_id                                                | 可 (インプット)                           | 可     | 空白       |
| お客様名称       | contract_applications.customer_name                                                             | 可 (インプット)                           | 可     | 空白       |
| 申込日時         | contract_applications.created_at {ブラウザのタイムゾーンに合わせる 例：yyyy-mm-ddThh:mm:ss JST} | 可 (日付選択、範囲指定)                   | 可     | 空白       |
| ステータス       | contract_applications.status                                                                    | 可 (セレクト:pending, approved, rejected) | 可     | 空白       |
| 契約状況         | contracts.application_id => contracts.status (or なし)                                          | 可 (セレクト:active, expired, なし)       | 可     | 空白       |
| 操作             | ボタン                                                                                          | 不可                                      | なし   | 契約を作成 |

> **【実装パターンに関する注記】**
> この一覧画面は、`docs/phase-2/INDEX_PAGE_IMPLEMENTATION_PATTERNS.md`で定義された、`<v-data-table-server>`コンポーネントを利用したサーバーサイド処理を標準パターンとして実装します。

### 4.3. バックエンド仕様

#### API エンドポイント

-   **URL**: `GET /api/admin/contract-applications`
-   **クエリパラメータ**:
    -   `statuses[]` (array): 申し込みステータス (`contract_applications.status`) による絞り込み（例: `pending`, `approved`）。複数指定可能。
    -   `contract_statuses[]` (array): 契約ステータスによる絞り込み（例: `active`, `expired`）。`none` を指定すると契約が存在しない申込を対象とします。複数指定可能。
-   **コントローラ**: `Api\Admin\ContractApplicationController@index`
-   **処理内容**:
    -   `contract_applications`テーブルのデータを取得します。
    -   各レコードについて、`user_id`を元に`users`テーブルをリレーションし、`public_id`を取得してレスポンスに含めます。
    -   フィルタリング、ソート、ページネーションに対応します。

---

## 5. オーナー情報・契約管理画面

### 5.1. 機能概要

特定のユーザーの詳細情報を確認し、オーナー権限の付与や契約の管理を行います。この画面は、オーナー権限一覧画面や契約申し込み一覧画面から遷移します。

### 5.2. 画面仕様詳細 (`/admin/users/{user}`)

この画面は、以下の主要な機能ブロックで構成されます。

#### 5.2.1. ユーザー情報と権限設定

-   **目的**: ユーザーの基本情報を確認し、オーナー権限を管理します。
-   **表示項目**:
    -   Public ID
    -   登録日時
    -   現在の役割 (Owner / User)
-   **UI 要素**:
    -   **オーナーにするボタン**: ユーザーがオーナーでない場合に表示。クリックすると`UsersController@update`を呼び出し、オーナー権限を付与する。
    -   **オーナー権限を解除するボタン**: ユーザーがオーナーである場合に表示。クリックすると`UsersController@update`を呼び出し、権限を解除する。

#### 5.2.2. 契約情報

-   **目的**: ユーザーがオーナーである場合に、契約情報を表示または新規作成します。
-   **表示パターン**:
    -   **契約が存在する場合**:
        -   **表示項目**: 契約名, 契約ステータス, 契約期間, 店舗上限数。
        -   **UI 要素**: 「契約を編集する」ボタンを配置（※将来実装）。
    -   **契約が存在しない場合 (ただしユーザーはオーナー)**:
        -   「このオーナーはまだ契約がありません。」というメッセージと共に、**新規契約追加フォーム**を表示する。

##### 新規契約追加フォーム

-   **目的**: このユーザーに対して新しい契約を作成します。
-   **フォーム送信先**: `POST /admin/contracts` (ルート名: `admin.contracts.store`)
-   **フォーム項目**:
    -   **契約名**:
        -   UI: `<input type="text">`
        -   必須項目。管理者が識別しやすい名前を入力します。（例: 「株式会社〇〇様 スタンダードプラン」）
        -   **[改善案]** 契約申し込みがあったユーザーの場合、その時のお客様名称を初期値として表示する。
    -   **店舗上限数**:
        -   UI: `<input type="number">`
        -   デフォルト値: 1
        -   必須項目。
    -   **契約開始日 / 終了日**:
        -   UI: `<input type="date">`
        -   必須項目。
    -   **契約ステータス**:
        -   UI: `<select>` プルダウン
        -   選択肢: `active` (有効), `pending` (保留) など。
        -   必須項目。
    -   **ユーザー ID (Hidden)**:
        -   UI: `<input type="hidden" name="user_id">`
        -   値: 現在表示しているユーザーの ID。
-   **ボタン**: 「契約を作成する」

### 5.3. バックエンド仕様

#### ルート定義 (`routes/web.php`)

```php
Route::prefix('admin')->name('admin.')->group(function () {
    // ...
    Route::resource('users', App\Http\Controllers\Admin\UsersController::class)->only(['index', 'show', 'update']);
    Route::resource('contracts', App\Http\Controllers\Admin\ContractsController::class)->only(['store']);
});
```

#### コントローラ (`Admin\ContractsController`)

-   **`store` メソッド**:
    -   `StoreContractRequest` を使ってバリデーションと認可を行います。
    -   `contracts` テーブルに新しいレコードを作成します。
    -   成功後、元のユーザー詳細画面 (`/admin/users/{user}`) にリダイレクトし、成功メッセージを表示します。

#### バリデーション (`App\Http\Requests\Admin\StoreContractRequest`)

-   `authorize` メソッド:
    -   リクエストを送信したユーザーが管理者 (`isAdmin()`) であることを確認します。
-   `rules` メソッド:
    -   `user_id`: 必須、`users`テーブルに存在すること。
    -   `name`: 必須、文字列であること。
    -   `max_shops`: 必須、数値であり、1 以上であること。
    -   `start_date`: 必須、日付形式であること。
    -   `end_date`: 必須、日付形式であり、`start_date`以降であること。
    -   `status`: 必須、指定された値（例: `active`, `pending`）のいずれかであること。

---

## 6. オーナー権限一覧画面

### 6.1. 機能概要

システムに登録されている全ユーザーについて、オーナーかどうかを一覧で確認し、オーナー権限設定画面へ遷移するための画面です。

### 6.2. 画面仕様詳細 (`/admin/users`)

#### 表示項目一覧

以下のテーブルは、オーナー権限一覧画面に表示される項目とその仕様を定義します。

| カラム名  | データソース                                                                        | フィルタ                | ソート | 操作 |
| :-------- | :---------------------------------------------------------------------------------- | :---------------------- | :----- | :--- |
| Public ID | users.public_id                                                                     | 可 (インプット)         | 可     |
| 役割      | {Owner かどうか。owners テーブルとの関連}                                           | 可 (セレクト)           | 可     |
| 登録日時  | users.created_at {クライアントのタイムゾーンに合わせる 例：yyyy-mm-ddThh:mm:ss JST} | 可 (日付選択、範囲指定) | 可     |
| 操作      | -                                                                                   | 不可                    | 不可   |

> **【パフォーマンス設計に関する注記】**
> この一覧画面は、表示パフォーマンスと UX を両立するため、ハイブリッド方式を採用しています。
>
> -   **初回読み込み時:** サーバーサイドでページネーション（1 ページあたり 20 件）を行い、高速な初期表示を実現します。
> -   **フィルタリング・ページ移動時:** クライアントサイド（Vue）が API を呼び出して、画面全体をリロードすることなく動的に一覧を更新し、スムーズな操作性を提供します。
>
> この方式は、`docs/INDEX_PAGE_IMPLEMENTATION_PATTERNS.md`で定義された、本プロジェクトにおける一覧画面の標準実装パターンです。

### 6.2. API エンドポイント

-   **URL**: `GET /api/admin/users`
-   **コントローラ**: `Api\Admin\UsersController@index`

### 4.2. 処理内容

-   `users`テーブルを主軸に、`owners`テーブルとのリレーションを考慮して一覧データを生成します。
-   `INDEX_PAGE_IMPLEMENTATION_PATTERNS.md`に記載された、動的な複数フィルタ条件（`where`, `whereHas`など）およびソートに対応します。
-   ページネーションを適用して結果を返却します。
