# 予約機能仕様書 (v1.2 Gemini改訂版)

## 1. 対象機能一覧

- Web 予約フォーム（スマホ対応）
- カレンダーから空き時間選択
- スタッフ指名（任意）
- 性別希望選択（任意）
- メニューごとの所要時間自動反映
- 予約内容の確認ページ
- 自動返信メール送信

---

## 2. アーキテクチャ方針

- **UI構築**: Vue 3 + Vuetify + TypeScript を用いて、動的でインタラクティブなUIを構築。
- **データ取得**: Laravel が提供する JSON API から非同期で取得。
- **予約実行**: 最終予約は Vue で管理するデータを `<input type="hidden">` にセットしてフォーム POST、Laravel 側で処理後リダイレクト。
- **日時管理**: 予約日時は ISO 8601 形式で保存、UTC 基準で管理し、フロントで店舗ローカルタイムに変換。サマータイムに対応できるよう、ローカルのタイムゾーンを一緒に保存する。
- **セキュリティ**: Laravel Policy を利用し、リソース（店舗情報、予約情報など）へのアクセス認可を徹底する。

---

## 3. 画面仕様詳細

予約フォームはステップ形式で構成。

- **URL**: `/bookings/create`
- **使用コンポーネント**: Vuetify `v-stepper`

---

### ステップ1: メニュー選択

- **目的**: 希望メニュー選択
- **UI**:
  - メニュー名・所要時間をリスト表示。
  - 選択は必須、`v-radio-group` で1つだけ選択可能。
  - **UX**: API通信中は `v-progress-circular` などのローディング表示を行う。
- **データフロー**:
  1. `GET /api/shops/{shop_id}/menus` で取得。
  2. レスポンス例：
     ```json
     [
       { "id": 1, "name": "カット", "duration": 60 },
       { "id": 2, "name": "カラー", "duration": 90 }
     ]
     ```
  3. Vue 内で選択された `menu_id` と `duration` を保持。
- **エラー処理**:
  - API エラー時は「メニュー情報を取得できませんでした」と表示し、再試行ボタンを設置。

---

### ステップ2: オプション選択（任意）

- **UI**:
  - **スタッフ指名**: `v-select`、デフォルト「指名なし」。
    - `GET /api/shops/{shop_id}/staff` で選択肢取得。
    ```json
    [
      { "id": 1, "name": "佐藤" },
      { "id": 2, "name": "鈴木" }
    ]
    ```
  - **性別希望**: `v-radio-group`、「指定なし」「男性」「女性」。
  - **UX**: API通信中はローディング表示を行う。
- **データフロー**:
  - `staff_id`, `gender_preference` を Vue 内で保持。
- **エラー処理**:
  - API 取得失敗時はコンポーネントを非表示にするか、選択不可とし、指名なしで進める。

---

### ステップ3: 日時選択

- **UI**:
  - 日付: `v-date-picker`、過去日・休業日は選択不可。
  - 時間: `v-chip-group`、選択された時間帯をハイライト。
  - **UX**: 空き時間取得中はローディング表示を行う。
- **データフロー**:
  1. 日付・メニュー・スタッフ選択の変化ごとに `GET /api/shops/{shop_id}/available-slots?date=YYYY-MM-DD&menu_id=X&staff_id=Y&gender_preference=Z`
  2. レスポンス例:
     ```json
     [
       "2025-09-07T10:00:00Z",
       "2025-09-07T11:00:00Z"
     ]
     ```
  3. Vue 内で `start_at` を保持（UTC）。
- **エラー処理**:
  - 取得失敗時は「予約可能時間を取得できませんでした」と表示し、日付やメニューの再選択を促す。

---

### ステップ4: お客様情報入力

- **UI**: `v-text-field` にて氏名・メール・電話番号入力。
- **バリデーション**:
  - 全項目必須。
  - メール形式チェック (リアルタイム)。
  - 電話番号形式チェック (リアルタイム)。
- **データフロー**:
  - Vue 内で `name`, `email`, `tel` を保持。

---

### ステップ5: 予約内容確認

- **UI**:
  - 選択・入力した全情報を表示。
  - 「内容を修正」 → 該当ステップに戻る。
  - 「予約を確定する」 → `<form method="POST" action="/bookings">` 送信。
  - **UX**: 送信ボタン押下後は、ボタンを無効化しローディング表示を行う（二重送信防止）。
- **データフロー**:
  - Vue 内の情報を `<input type="hidden">` に反映。
  - 送信後、Laravel が処理して `/bookings/complete` にリダイレクト。

---

## 4. バックエンド仕様

### データモデル
本仕様書で言及されるデータは、以下の主要モデルと関連する。詳細は `ARCHITECTURE.md` を参照。
- `Shop`: 店舗情報
- `Menu`: メニュー情報
- `Staff`: スタッフ情報
- `Booking`: 予約情報
- `User`: ユーザー情報 (Owner, Booker, Staff)

### 予約処理

- **ルート**: `POST /bookings`
- **コントローラ**: `BookingsController@store`
- **処理内容**:
  1. `FormRequest` によるバリデーションと**認可チェック** (`authorize` メソッド)。
  2. 予約日時の二重予約チェック:
     - DBから予約枠を取得。
     - アプリ側で予約可能な時間を計算し、UIに表示。
     - ユーザーからの予約POST時にDBの状況をチェック。
     - 予約可能であれば、予約登録SQLを実行。
     - SQL実行後、DBの予約内容を再度チェック。
     - アプリ側のチェックがOKであれば登録を確定、NGであればロールバック（2フェーズコミットのような形）。
  3. `bookings` テーブルにデータ永続化。
  4. 自動返信メール送信ジョブをキューに追加。
  5. 完了ページへリダイレクト。

### 自動返信メール

- **タイミング**: 予約確定後。
- **実装**: Laravel `Mailable` クラス + キュー。
- **内容**:
  - 予約日時、メニュー、店舗情報、予約番号。
  - キャンセル案内。