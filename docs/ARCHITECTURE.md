# ARCHITECTURE.md

## 1. 目的

この文書は予約サービスの **システムアーキテクチャ** を定義し、開発・運用・将来的な拡張において共通認識を持つことを目的とする。  
本システムは **マルチテナント型予約サービス** として設計する。

---

## 2. 全体構成

-   **フロントエンド**: Laravel + Blade (MPA) を基本とし、一部 Vue 3 + Vuetify + TypeScript による動的 UI
-   **バックエンド**: Laravel (API 提供 + 認証・セッション管理)
-   **データベース**: 単一 DB + `shop_id` スコープ管理（将来的に DB 分離型マルチテナントへ拡張可能）
-   **認可**: Laravel Gate / Policy によるロール判定
-   **契約管理**: Owner とシステム間の契約状態（有効/無効/期限切れ）を DB で管理し、Policy 判定に利用

---

## 3. ユーザーロールと責務
`AUTHORIZATION_SPEC.md` を参照。

---

## 4. データモデル

`DATABASE_SCHEMA.md` を参照。

---

## 5. 顧客アカウントモデルと統合ロジック

本システムでは、ゲスト予約と会員登録ユーザーを柔軟に紐付けるため、「マスターアカウントモデル」を採用する。

### 5.1. モデルの役割

-   **`users` (顧客台帳)**: 顧客の本体を表すマスターテーブル。
-   **`bookers` (来店カード)**: 予約に紐づく識別子。`users`に多対一で紐づく。
-   **`bookings` (予約票)**: 予約情報。`bookers`に紐づく。

### 5.2. アカウント作成フロー

1.  **ゲスト予約時**:
    -   `users`テーブルに、`is_guest=true`の「仮マスターアカウント」が作成される。
    -   `bookers`テーブルに識別子が作成され、上記の仮マスターに紐づく。
    -   `bookings`テーブルに、`type='guest'`の予約情報が作成され、上記の識別子に紐づく。

2.  **会員登録（SNSログイン）時**:
    -   `users`テーブルに`is_guest=false`の「正規マスターアカウント」が作成される。
    -   （将来的には、メールアドレス等で既存の仮マスターを探し、それを正規マスターに「昇格」させるフローも考えられる）

### 5.3. 顧客統合（名寄せ）フロー

店舗スタッフは、管理画面上で「ゲスト予約の顧客」を「既存の会員」に統合できる。

-   **処理**: システムは、ゲスト予約の`bookers`レコードが指している`user_id`を、統合先となる正規マスターアカウントの`user_id`に更新する。
-   **結果**: `bookings`テーブルのレコードは一切変更することなく、ゲスト予約が正規マスターアカウントに紐づく。

### 5.4. 予約履歴の表示ロジック

このモデルにより、予約履歴の表示を柔軟に制御する。

-   **店舗側画面**: ある顧客の予約を確認する際は、その顧客の`user_id`に紐づく全ての`bookers`レコードを辿り、全ての予約を表示する。
-   **ユーザー側画面（マイページ）**: ログインユーザーの`user_id`に紐づく`bookers`レコードを辿り、`bookings`テーブルの`type`が`'login'`の予約のみを表示する。これにより、ユーザーが意図しないゲスト予約（代理予約など）が履歴に表示されることを防ぐ。

---

## 6. ディレクトリ構成

app/Http/Controllers/Booker/
app/Http/Controllers/Staff/
app/Http/Controllers/Owner/
app/Http/Controllers/Admin/
app/Services/ ← 共通ロジック
app/Policies/ ← 認可制御
resources/views/booker/
resources/views/staff/
resources/views/owner/
resources/views/admin/

---

## 7. 認可設計

-   `shop_user.role` に基づいてアクセス制御
-   Booker: 任意の店舗に予約可能（shop_slug 必須）
-   Staff: 自店舗のみ操作可能
-   Owner: 自店舗操作 + 契約管理可
-   Admin: 契約管理可
-   契約状態が無効 / 期限切れの場合は、店舗機能を利用不可とする

---

## 8. マルチテナントのデータ分離戦略

本システムは、オーナーやスタッフが自身の所属する店舗の情報のみを閲覧・操作できるよう、複数の仕組みを組み合わせてデータ分離を実現する。

### 8.1. グローバルスコープによる自動的な絞り込み

-   **目的**: 開発者の `where('shop_id', ...)` の記述漏れによる意図しない情報漏洩を、システムレベルで防止する。
-   **仕組み**:
    -   `Booking`, `Menu`, `Option` など、店舗に所属する主要なモデルには **グローバルスコープ** を適用する。
    -   このスコープは、現在ログインしているユーザーがオーナーまたはスタッフの場合、自動的にそのユーザーが所属する `shop_id` でクエリを絞り込む `WHERE` 句を追加する。
    -   これにより、例えばコントローラーで `Booking::all()` を呼び出した場合でも、実際には自店舗の予約のみが取得される。

### 8.2. Policyによる個別アクセスの認可

-   **目的**: URLを直接操作するなどの意図的な不正アクセスを防ぎ、個別のデータに対する操作権限を厳密に検証する。
-   **仕組み**:
    -   各モデルに対応する Policy (`BookingPolicy`, `ShopPolicy` など) を用意する。
    -   `update` や `delete` などのメソッド内で、操作対象のデータ（例: `$booking`）の `shop_id` が、操作しようとしているユーザーの所属する `shop_id` と一致するかを検証する。
    -   コントローラーの各メソッドの冒頭で `$this->authorize(...)` を呼び出すことで、この検証を強制する。

この2つの仕組みを組み合わせることで、テナントデータの安全な分離を堅牢に実現する。

---

## 9. API 設計方針

### 1. Booker（予約者向け）

| 機能           | Path                                            | メモ                           |
| -------------- | ----------------------------------------------- | ------------------------------ |
| 予約一覧       | `/shops/{shop_slug}/bookings`                     | ログイン済み/ゲスト両対応      |
| 予約作成       | `/shops/{shop_slug}/bookings/new`                 | カレンダー・空き時間選択ページ |
| 予約詳細       | `/shops/{shop_slug}/bookings/{booking_id}`        | 予約確認ページ                 |
| 予約変更       | `/shops/{shop_slug}/bookings/{booking_id}/edit`   | 期限内のみ可能                 |
| 予約キャンセル | `/shops/{shop_slug}/bookings/{booking_id}/cancel` | 期限内のみ可能                 |

### 2. Staff（店舗スタッフ向け）

| 機能           | Path                                           | メモ                     |
| -------------- | ---------------------------------------------- | ------------------------ |
| ダッシュボード | `/shops/{shop_slug}/staff/dashboard`             | 自分の店舗専用           |
| 予約一覧       | `/shops/{shop_slug}/staff/bookings`              | フィルタ/ソートあり      |
| 予約作成       | `/shops/{shop_slug}/staff/bookings/new`          | カレンダー・空き時間選択ページ |
| 予約詳細       | `/shops/{shop_slug}/staff/bookings/{booking_id}` | 詳細確認・ステータス変更 |
| 予約可能枠管理 | `/shops/{shop_slug}/staff/schedules`             | 自分のシフト登録・更新   |

### 3. Owner（店舗オーナー向け）

| 機能           | Path                                           | メモ                   |
| -------------- | ---------------------------------------------- | ---------------------- |
| ダッシュボード | `/owner/dashboard`                             | 複数店舗横断可         |
| 店舗一覧       | `/owner/shops`                                 | 自分が契約する店舗のみ |
| 店舗詳細       | `/owner/shops/{shop_slug}`                       | 店舗情報確認・編集     |
| スタッフ管理   | `/owner/shops/{shop_slug}/staff`                 | スタッフ一覧・追加     |
| スタッフ編集   | `/owner/shops/{shop_slug}/staff/{staff_id}/edit` | 権限・シフト変更など   |
| 契約管理       | `/owner/contracts`                             | 契約更新・停止など     |

### 4. Admin（全体管理者向け）

| 機能         | Path                             | メモ                   |
| ------------ | -------------------------------- | ---------------------- |
| オーナー管理 | `/admin/owners`                  | 一覧・追加・削除       |
| オーナー詳細 | `/admin/owners/{owner_id}`       | 契約・店舗情報管理     |
| 契約管理     | `/admin/contracts/{contract_id}` | 契約ステータス変更など |

---

## 10. データ削除方針

本システムでは、ユーザーの退会やメニューの廃止など、マスターデータの物理削除が行われることを前提として設計する。

### 参照整合性の担保

マスターデータが物理削除された際に、`bookings`テーブルなどのスナップショット情報との不整合を防ぐため、アプリケーションは以下の責務を負う。

1.  **モデルイベントの利用**: Laravelのモデルイベント（特に`deleting`または`deleted`イベント）を利用し、マスターレコードの削除を検知する。
2.  **関連IDのNULL化**: 削除イベントを検知後、`bookings`テーブルに記録されている関連ID（`menu_id`, `requested_staff_id`, `assigned_staff_id`）を自動的に`NULL`に更新する。

これにより、個人情報との関連を完全に断ち切りつつ、予約記録の匿名性とスナップショットとしての独立性を担保する。