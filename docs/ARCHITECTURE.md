# ARCHITECTURE.md

## 1. 目的

この文書は予約サービスの **システムアーキテクチャ** を定義し、開発・運用・将来的な拡張において共通認識を持つことを目的とする。  
本システムは **マルチテナント型予約サービス** として設計する。

---

## 2. 全体構成

-   **フロントエンド**: Laravel + Blade (MPA) を基本とし、一部 Vue 3 + Vuetify + TypeScript による動的 UI
-   **バックエンド**: Laravel (API 提供 + 認証・セッション管理)
-   **データベース**: 単一 DB + `shop_id` スコープ管理（将来的に DB 分離型マルチテナントへ拡張可能）
-   **認可**: Laravel Gate / Policy によるロール判定
-   **契約管理**: Owner とシステム間の契約状態（有効/無効/期限切れ）を DB で管理し、Policy 判定に利用

---

## 3. ユーザーロールと責務

-   **Booker (予約者)**
    -   店舗に対して予約可能
-   **Staff (店舗スタッフ)**
    -   店舗の予約枠登録・予約者管理
-   **Owner (店舗オーナー)**
    -   店舗・スタッフの管理
    -   契約管理（プランや利用可否の判定）
-   **Admin (予約システム管理者)**
    -   契約管理（プランや利用可否の判定）

---

## 4. データモデル

主要なデータモデルは以下の通り。詳細は `DATABASE_SCHEMA.md` を参照。

-   **ユーザー関連**
    -   `users`: 全てのロールの基本アカウント情報。`public_id` を持ち、ゲストかどうかのフラグ (`is_guest`) を持つ。
    - `admins`: システム管理者。
    -   `owners`: 店舗オーナー。
    -   `roles`: `owner`, `staff` などの役割定義。
    -   `user_oauth_identities`: 外部認証情報。

-   **店舗・スタッフ関連**
    -   `shops`: 店舗情報。予約枠の間隔やキャンセル期限などの設定もここに含む。
    -   `shop_user_role`: ユーザーと店舗、役割を紐付ける中間テーブル。
    -   `user_shop_profiles`: 店舗ごとのスタッフのプロフィール情報。
    -   `staff_schedules`: スタッフの日ごとの勤務シフト。`datetime`型で管理し、日またぎ勤務に対応。

-   **休日・営業時間関連**
    -   `shop_regular_holidays`: 店舗の定休日（毎週の特定の曜日）を管理する。
    -   `shop_specific_holidays`: 店舗の特別休業日（年末年始など）を管理。

-   **メニュー・オプション関連**
    -   `menus`: 基本となるメニュー情報（価格、所要時間など）。**担当者指定が必須かを選択できるフラグ(`requires_staff_assignment`)を持ち、柔軟な予約フローを実現する。**
    -   `options`: 追加可能なオプションの情報。
    -   `menu_option`: メニューと、それに紐づくオプションの組み合わせを定義する中間テーブル。
    -   `menu_staff`: メニューと、それを提供可能なスタッフを紐付ける中間テーブル。

-   **予約・契約関連**
    -   `bookings`: 予約情報を記録する**スナップショットテーブル**。予約時のメニュー名、価格などを全て記録する。**顧客が希望した担当者(`requested_staff_id`)と、実際に割り当てられた担当者(`assigned_staff_id`)を区別して管理し、指名なし予約にも対応する。**
    -   `booking_option`: 予約にどのオプションが追加されたかを記録する中間テーブル。
    -   `contracts`: 店舗オーナーとシステムとの契約情報。

## 5. ディレクトリ構成

app/Http/Controllers/Booker/
app/Http/Controllers/Staff/
app/Http/Controllers/Owner/
app/Http/Controllers/Admin/
app/Services/ ← 共通ロジック
app/Policies/ ← 認可制御
resources/views/booker/
resources/views/staff/
resources/views/owner/
resources/views/admin/

---

## 6. 認可設計

-   `shop_user.role` に基づいてアクセス制御
-   Booker: 任意の店舗に予約可能（shop_slug 必須）
-   Staff: 自店舗のみ操作可能
-   Owner: 自店舗操作 + 契約管理可
-   Admin: 契約管理可
-   契約状態が無効 / 期限切れの場合は、店舗機能を利用不可とする

---

## 7. マルチテナントのデータ分離戦略

本システムは、オーナーやスタッフが自身の所属する店舗の情報のみを閲覧・操作できるよう、複数の仕組みを組み合わせてデータ分離を実現する。

### 7.1. グローバルスコープによる自動的な絞り込み

-   **目的**: 開発者の `where('shop_id', ...)` の記述漏れによる意図しない情報漏洩を、システムレベルで防止する。
-   **仕組み**:
    -   `Booking`, `Menu`, `Option` など、店舗に所属する主要なモデルには **グローバルスコープ** を適用する。
    -   このスコープは、現在ログインしているユーザーがオーナーまたはスタッフの場合、自動的にそのユーザーが所属する `shop_id` でクエリを絞り込む `WHERE` 句を追加する。
    -   これにより、例えばコントローラーで `Booking::all()` を呼び出した場合でも、実際には自店舗の予約のみが取得される。

### 7.2. Policyによる個別アクセスの認可

-   **目的**: URLを直接操作するなどの意図的な不正アクセスを防ぎ、個別のデータに対する操作権限を厳密に検証する。
-   **仕組み**:
    -   各モデルに対応する Policy (`BookingPolicy`, `ShopPolicy` など) を用意する。
    -   `update` や `delete` などのメソッド内で、操作対象のデータ（例: `$booking`）の `shop_id` が、操作しようとしているユーザーの所属する `shop_id` と一致するかを検証する。
    -   コントローラーの各メソッドの冒頭で `$this->authorize(...)` を呼び出すことで、この検証を強制する。

この2つの仕組みを組み合わせることで、テナントデータの安全な分離を堅牢に実現する。

---

## 8. API 設計方針

### 1. Booker（予約者向け）

| 機能           | Path                                            | メモ                           |
| -------------- | ----------------------------------------------- | ------------------------------ |
| 予約一覧       | `/shops/{shop_slug}/bookings`                     | ログイン済み/ゲスト両対応      |
| 予約作成       | `/shops/{shop_slug}/bookings/new`                 | カレンダー・空き時間選択ページ |
| 予約詳細       | `/shops/{shop_slug}/bookings/{booking_id}`        | 予約確認ページ                 |
| 予約変更       | `/shops/{shop_slug}/bookings/{booking_id}/edit`   | 期限内のみ可能                 |
| 予約キャンセル | `/shops/{shop_slug}/bookings/{booking_id}/cancel` | 期限内のみ可能                 |

### 2. Staff（店舗スタッフ向け）

| 機能           | Path                                           | メモ                     |
| -------------- | ---------------------------------------------- | ------------------------ |
| ダッシュボード | `/shops/{shop_slug}/staff/dashboard`             | 自分の店舗専用           |
| 予約一覧       | `/shops/{shop_slug}/staff/bookings`              | フィルタ/ソートあり      |
| 予約作成       | `/shops/{shop_slug}/staff/bookings/new`          | カレンダー・空き時間選択ページ |
| 予約詳細       | `/shops/{shop_slug}/staff/bookings/{booking_id}` | 詳細確認・ステータス変更 |
| 予約可能枠管理 | `/shops/{shop_slug}/staff/schedules`             | 自分のシフト登録・更新   |

### 3. Owner（店舗オーナー向け）

| 機能           | Path                                           | メモ                   |
| -------------- | ---------------------------------------------- | ---------------------- |
| ダッシュボード | `/owner/dashboard`                             | 複数店舗横断可         |
| 店舗一覧       | `/owner/shops`                                 | 自分が契約する店舗のみ |
| 店舗詳細       | `/owner/shops/{shop_slug}`                       | 店舗情報確認・編集     |
| スタッフ管理   | `/owner/shops/{shop_slug}/staff`                 | スタッフ一覧・追加     |
| スタッフ編集   | `/owner/shops/{shop_slug}/staff/{staff_id}/edit` | 権限・シフト変更など   |
| 契約管理       | `/owner/contracts`                             | 契約更新・停止など     |

### 4. Admin（全体管理者向け）

| 機能         | Path                             | メモ                   |
| ------------ | -------------------------------- | ---------------------- |
| オーナー管理 | `/admin/owners`                  | 一覧・追加・削除       |
| オーナー詳細 | `/admin/owners/{owner_id}`       | 契約・店舗情報管理     |
| 契約管理     | `/admin/contracts/{contract_id}` | 契約ステータス変更など |

---

## 8. データ削除方針

本システムでは、ユーザーの退会やメニューの廃止など、マスターデータの物理削除が行われることを前提として設計する。

### 参照整合性の担保

マスターデータが物理削除された際に、`bookings`テーブルなどのスナップショット情報との不整合を防ぐため、アプリケーションは以下の責務を負う。

1.  **モデルイベントの利用**: Laravelのモデルイベント（特に`deleting`または`deleted`イベント）を利用し、マスターレコードの削除を検知する。
2.  **関連IDのNULL化**: 削除イベントを検知後、`bookings`テーブルに記録されている関連ID（`booker_id`, `menu_id`, `requested_staff_id`, `assigned_staff_id`）を自動的に`NULL`に更新する。

これにより、個人情報との関連を完全に断ち切りつつ、予約記録の匿名性とスナップショットとしての独立性を担保する。